#include <SoftwareSerial.h>
const String PHONE = "+256752132243";
#define rxPin 2
#define txPin 3
SoftwareSerial sim800(rxPin, txPin);
#define trigPin 6
#define echoPin 7
 
void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
 
  Serial.begin(9600);
 
  sim800.begin(9600);
  Serial.println("SIM800L software serial initialize");
 
  sim800.println("AT");
  delay(1000);
  sendATCommand("AT+CPIN?");

  // Set SMS mode
  sendATCommand("AT+CMGF=1");
}
 
void loop() {
 
  while (sim800.available()) {
    Serial.println(sim800.readString());
  }
 
  while (Serial.available())  {
    sim800.println(Serial.readString());
  }
 
  long time_duration, distance_in_cm;
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  time_duration = pulseIn(echoPin, HIGH);
  distance_in_cm = time_duration / 29 / 2;
 
  Serial.print(distance_in_cm);
  Serial.println(" cm");
 
  if (distance_in_cm <= 10) {
    Serial.println("Pump full");
    Serial.println("sending message....");
    sendSMS("+256752132243", "D1 OFF");
    //sim800.println("ATD" + PHONE + ";");
    delay(10000); //20 sec delay
  }
  else if (distance_in_cm > 110){
    Serial.println("Pump empty");
    Serial.println("sending message....");
    sendSMS("+256752132243", "D1 ON");
    //sim800.println("ATD" + PHONE + ";");
    delay(10000); //20 sec delay
  }
  delay(500);
}

// edit starts here

void sendATCommand(String command) {
  sim800.println(command);
  delay(500);

  while (sim800.available()) {
    String response = sim800.readStringUntil('\n');
    Serial.println(response);
  }
}

void sendSMS(String phoneNumber, String message) {
  String command = "AT+CMGS=\"" + phoneNumber + "\"";
  sendATCommand(command);
  delay(500);
  sim800.print(message);
  delay(500);
  sim800.write(26);  // End the SMS by sending Ctrl+Z
  delay(1000);
}
